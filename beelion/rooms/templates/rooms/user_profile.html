{% extends 'main/layout.html' %}

{% block title %}Профиль{% endblock %}

{% block content %}
<div class="profile-container">
    <h2 class="glav_text">Профиль пользователя</h2>
    <br>
    <hr>

    <!-- Сообщения о статусе бронирования -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Информация о пользователе -->
    <div class="user-info">
        <h3>Личная информация</h3><br>
        <p><strong>Имя:</strong> {{ user.username }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
    </div>
    <hr>

    <!-- Активные бронирования -->
    <h3>Активные бронирования</h3>
    {% if active_bookings %}
        <table class="booking-table">
            <thead>
                <tr>
                    <th>Комната</th>
                    <th>Даты</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in active_bookings %}
                <tr>
                    <td>{{ booking.room.name }}</td>
                    <td>{{ booking.start_date }} - {{ booking.end_date }}</td>
                    <td>{{ booking.total_price }} руб.</td>
                    <td><span class="status active">Активно</span></td>
                    <td>
                        <button class="btn cancel-btn" type="button" onclick="cancelBooking({{ booking.pk }})">Отменить</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Нет активных бронирований.</p>
    {% endif %}

    <hr>

    <!-- Предстоящие бронирования -->
    <h3>Предстоящие бронирования</h3>
    {% if upcoming_bookings %}
        <table class="booking-table">
            <thead>
                <tr>
                    <th>Комната</th>
                    <th>Даты</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in upcoming_bookings %}
                <tr>
                    <td>{{ booking.room.name }}</td>
                    <td>{{ booking.start_date }} - {{ booking.end_date }}</td>
                    <td>{{ booking.total_price }} руб.</td>
                    <td><span class="status upcoming">Предстоящие</span></td>
                    <td>
                        <button class="btn cancel-btn" type="button" onclick="cancelBooking({{ booking.pk }})">Отменить</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Нет предстоящих бронирований.</p>
    {% endif %}

    <hr>

    <!-- Завершенные бронирования -->
    <h3>Завершенные бронирования</h3>
    {% if completed_bookings %}
        <table class="booking-table">
            <thead>
                <tr>
                    <th>Комната</th>
                    <th>Даты</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in completed_bookings %}
                <tr>
                    <td>{{ booking.room.name }}</td>
                    <td>{{ booking.start_date }} - {{ booking.end_date }}</td>
                    <td>{{ booking.total_price }} руб.</td>
                    <td><span class="status completed">Завершено</span></td>
                    <td>---</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Нет завершённых бронирований.</p>
    {% endif %}

    <hr>

    <!-- Отмененные бронирования -->
    <h3>Отмененные бронирования</h3>
    {% if canceled_bookings %}
        <table class="booking-table">
            <thead>
                <tr>
                    <th>Комната</th>
                    <th>Даты</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in canceled_bookings %}
                <tr>
                    <td>{{ booking.room.name }}</td>
                    <td>{{ booking.start_date }} - {{ booking.end_date }}</td>
                    <td>{{ booking.total_price }} руб.</td>
                    <td><span class="status canceled">Отменено</span></td>
                    <td>---</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Нет отменённых бронирований.</p>
    {% endif %}

</div>

<script>
    function cancelBooking(bookingId) {
        if (confirm("Вы уверены, что хотите отменить бронирование?")) {
            fetch(`/rooms/cancel_booking/${bookingId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ 'id': bookingId }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при отмене бронирования');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert("Бронирование успешно отменено.");
                    location.reload();
                } else {
                    alert("Ошибка при отмене бронирования: " + data.error);
                }
            })
            .catch(error => {
                alert("Произошла ошибка при отмене бронирования: " + error);
            });
        }
    }
</script>
{% endblock %}
