{% extends 'main/layout.html' %}
{% block title %}Добавить бронирование{% endblock %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Добавить бронирование</h2>
    <div class="card shadow-sm p-4">
        <form method="POST" id="booking-form">
            {% csrf_token %}
            <input type="hidden" name="payment_method" id="id_payment_method" value="cash">

            <div class="mb-3">
                <label for="id_user" class="form-label">Выберите пользователя</label>
                <select name="user" id="id_user" class="form-select">
                    {% for user in form.user.field.queryset %}
                        <option value="{{ user.id }}" {% if user.id == form.user.value %}selected{% endif %}>{{ user }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="id_room" class="form-label">Комната</label>
                <select name="room" id="id_room" class="form-select">
                    {% for room in form.room.field.queryset %}
                        <option value="{{ room.id }}" {% if room.id == form.room.value %}selected{% endif %}>{{ room }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="id_start_date" class="form-label">Дата начала</label>
                {{ form.start_date|add_class:"form-control" }}
            </div>

            <div class="mb-3">
                <label for="id_end_date" class="form-label">Дата конца</label>
                {{ form.end_date|add_class:"form-control" }}
            </div>

            <div class="mb-3">
                <label for="id_phone_number" class="form-label">Номер телефона</label>
                <input type="tel" name="phone_number" id="id_phone_number" class="form-control" value="{{ form.phone_number.value }}">
            </div>

            <div class="mb-3">
                <label class="form-label">Способ оплаты</label><br>
                <button type="button" class="btn btn-outline-primary" id="cash-button" onclick="selectPaymentMethod('cash')">Наличными</button>
                <button type="button" class="btn btn-outline-primary" id="card-button" onclick="selectPaymentMethod('card')">Картой</button>
            </div>

            <div id="cash-text" style="display:none;">
                <p>Оплата будет произведена на кассе.</p>
            </div>

            <div id="card-number-field" class="mb-3" style="display:none;">
                <label for="id_card_number" class="form-label">Номер карты</label>
                <input type="text" name="card_number" id="id_card_number" maxlength="16" placeholder="Введите номер карты" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Дополнительные услуги:</label>
                <div id="services-list">
                    {% for service in services %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input service-checkbox" id="service-{{ service.id }}" name="services" value="{{ service.id }}" data-price="{{ service.price }}">
                            <label class="form-check-label" for="service-{{ service.id }}">
                                {{ service.name }} (Цена: {{ service.price }} тенге)
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <p><strong>Цена за день:</strong> <span id="room-price">{{ room.price }}</span> тенге</p>

            <p><strong>Расчетная стоимость:</strong> <span id="calculated-price">0</span> тенге</p>

            <button type="submit" class="btn btn-primary btn-lg mt-4 w-100">Сохранить</button>
        </form>
    </div>
</div>

<script>
    const startDateInput = document.getElementById("id_start_date");
    const endDateInput = document.getElementById("id_end_date");
    const calculatedPriceElement = document.getElementById("calculated-price");
    const serviceCheckboxes = document.querySelectorAll(".service-checkbox");

    // Получаем цену за день из контекста Django
    const pricePerDay = parseFloat("{{ room.price }}");

    // Функция для расчета стоимости
    function calculatePrice() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        let totalPrice = 0;

        // Проверка правильности дат
        if (startDate && endDate && endDate > startDate) {
            const timeDifference = endDate - startDate;
            const days = timeDifference / (1000 * 3600 * 24); // миллисекунды в дни
            totalPrice += days * pricePerDay;
        }

        // Добавляем стоимость выбранных услуг
        serviceCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const servicePrice = parseFloat(checkbox.dataset.price);
                totalPrice += servicePrice;
            }
        });

        // Обновляем расчетную стоимость
        calculatedPriceElement.textContent = totalPrice.toFixed(2);
    }

    // Добавляем обработчики событий для расчета
    startDateInput.addEventListener("input", calculatePrice);
    endDateInput.addEventListener("input", calculatePrice);
    serviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener("change", calculatePrice);
    });

    // Функция для выбора способа оплаты
    function selectPaymentMethod(method) {
        const cashText = document.getElementById("cash-text");
        const cardNumberField = document.getElementById("card-number-field");
        const cashButton = document.getElementById("cash-button");
        const cardButton = document.getElementById("card-button");
        const paymentMethodField = document.getElementById("id_payment_method");

        if (method === 'cash') {
            cashText.style.display = "block";
            cardNumberField.style.display = "none";

            cashButton.classList.add("btn-primary");
            cashButton.classList.remove("btn-outline-primary");
            cardButton.classList.remove("btn-primary");
            cardButton.classList.add("btn-outline-primary");

            paymentMethodField.value = "cash";
        } else if (method === 'card') {
            cashText.style.display = "none";
            cardNumberField.style.display = "block";

            cardButton.classList.add("btn-primary");
            cardButton.classList.remove("btn-outline-primary");
            cashButton.classList.remove("btn-primary");
            cashButton.classList.add("btn-outline-primary");

            paymentMethodField.value = "card";
        }
    }

    // Инициализация: по умолчанию выбираем оплату наличными
    document.getElementById("id_payment_method").value = "cash";

    calculatePrice();
</script>
{% endblock %}
